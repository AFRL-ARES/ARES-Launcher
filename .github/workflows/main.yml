name: ARES Launcher Release Pipeline

on:
  release:
    types: [released]

env:
  PROJECT_FILE: 'ARESLauncher.Desktop/ARESLauncher.Desktop.csproj'
  OUTPUT_PATH: 'publish'
  ARES_OS_REPO: 'AFRL-ARES/ARES'

jobs:
  build-and-deploy:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            runtime_id: linux-x64
            os_name_tag: linux
            payload_pattern: '*linux*' 
          - os: windows-latest
            runtime_id: win-x64
            os_name_tag: windows
            payload_pattern: '*windows*'
          - os: macos-latest
            runtime_id: osx-arm64
            os_name_tag: macos
            payload_pattern: '*macos*' 

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    env:
      ZIP_FILE_NAME: 'ARES-LAUNCHER-${{ github.event.release.tag_name }}-${{ matrix.os_name_tag }}.zip'
      DMG_FILE_NAME: 'ARES-LAUNCHER-${{ github.event.release.tag_name }}-${{ matrix.os_name_tag }}.dmg'
      OFFLINE_ZIP_NAME: 'ARES-LAUNCHER-Offline-${{ github.event.release.tag_name }}-${{ matrix.os_name_tag }}.zip'
    
    steps:
    - name: Setup Variables
      run: |
        TAG="${{ github.event.release.tag_name }}"
        
        echo "Using Version Tag: $TAG"
        
        # Calculate file names and push them to GITHUB_ENV so subsequent steps can see them
        echo "ZIP_FILE_NAME=ARES_Launcher_${TAG}-${{ matrix.os_name_tag }}.zip" >> $GITHUB_ENV
        echo "OFFLINE_ZIP_NAME=ARES_Launcher_${TAG}-offline-${{ matrix.os_name_tag }}.zip" >> $GITHUB_ENV
        echo "DMG_FILE_NAME=ARES_Launcher_${TAG}-${{ matrix.os_name_tag }}.dmg" >> $GITHUB_ENV
        echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore Dependencies
      run: dotnet restore ${{ env.PROJECT_FILE }}

    - name: Build and Publish Self-Contained Release Artifacts
      shell: bash
      run: |
        TAG=${{ env.RELEASE_TAG }}
        VERSION=${TAG#v}
        echo "Publishing ARES Launcher Project for ${{ matrix.os_name_tag }}  (${{ matrix.runtime_id }})"
        
        dotnet publish "${{ env.PROJECT_FILE }}" \
          --configuration Release \
          --output "${{ env.OUTPUT_PATH }}" \
          -r "${{ matrix.runtime_id }}" \
          --self-contained true \
          -p:UseAppHost=true \
          -p:PublishSingleFile=true \
          -p:Version="$VERSION"

    - name: Package for macOS
      if: runner.os == 'macOS'
      run: |
        chmod +x package-macos.sh
        VERSION=${{ github.event.release.tag_name }}
        ./package-macos.sh ${{ env.OUTPUT_PATH }} ${VERSION#v} ${{ env.DMG_FILE_NAME }}

    - name: Create ZIP Archive (Windows)
      shell: pwsh
      if: runner.os == 'Windows'
      run: 7z a -r "${{ env.ZIP_FILE_NAME }}" .\"${{ env.OUTPUT_PATH }}\*"
      
    - name: Create ZIP Archive (Linux)
      if: runner.os == 'Linux'
      run: |
        cd ${{ env.OUTPUT_PATH }}
        zip -r ../${{ env.ZIP_FILE_NAME }} .

    - name: Prepare Offline Directory
      run: |
        mkdir -p OfflineBuild/Offline
        cp -r ${{ env.OUTPUT_PATH }}/* OfflineBuild/

    - name: Download ARES OS Payload
      shell: bash
      run: |
        gh release download \
        --repo ${{ env.ARES_OS_REPO }} \
        --pattern "${{ matrix.payload_pattern }}" \
        --dir OfflineBuild/Offline
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Zip Offline Bundle (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: 7z a -r "${{ env.OFFLINE_ZIP_NAME }}" .\OfflineBuild\*

    - name: Zip Offline Bundle (Mac/Linux)
      if: runner.os != 'Windows'
      run: |
        cd OfflineBuild
        zip -r ../${{ env.OFFLINE_ZIP_NAME }} .
    
    - name: Upload Published Binaries to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.ZIP_FILE_NAME }}
          ${{ env.OFFLINE_ZIP_NAME }}
          ${{ env.DMG_FILE_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
